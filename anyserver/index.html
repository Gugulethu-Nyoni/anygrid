<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Management</title>

  <link rel="stylesheet" href="./anyGrid.css" />
  <link rel="stylesheet" href="./formique-css.css" />

  <style>
    .anygrid-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1000;
    }
    .anygrid-modal.active {
      display: block;
    }
    .width-half {
      width: 50%;
    }
  </style>

  <script type="module">
    import AnyGrid from './anygrid.js';
    import smQL, { Form } from './smQL.js';
    import Formique from './formique-semantq.js';

    // Utility to convert string to Title Case
    function toTitleCase(str) {
      return str.replace(/\w\S*/g, txt =>
        txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
      );
    }

    // Grid column definitions for categories
    const categoryColumns = [
      {
        name: 'id',
        header: 'ID',
        render: (value, row) => `<a href="/user/profile/${row.id}">${row.id}</a>`,
        sortable: true
      },
      { name: 'name', header: 'Title' },
      {
        name: 'description',
        header: 'Description',
        sortable: true,
        actions: [
          { label: 'EDIT', url: 'edit/{id}', class: 'edit', id: 'edit-{id}' },
          { label: 'DELETE', url: 'delete/{id}', class: 'delete', id: 'delete-{id}', confirm: true }
        ]
      }
    ];

    // Category grid features
    const categoryFeatures = {
      initialItemsPerPage: 5,
      csvExport: true,
      excelExport: true,
      theme: 'light',
      themeColor: '#556B2F',
      gridModal: true,
      modalConfig: {
        editable: true,
        nonEditableFields: ['id', 'uuid', 'status', 'sortOrder', 'createdAt', 'updatedAt'],
        deletable: true,
      },
      dataApiEndPoint: 'http://localhost:3003/productcategory/productcategories',
    };

    // Product grid columns
    const productColumns = [
      { name: 'id', header: 'ID', sortable: true},
      { name: 'title', header: 'Title', sortable: true },
      { name: 'description', header: 'Description', sortable: true },
      { name: 'status', header: 'Status',sortable: true },
      { name: 'currency', header: 'Currency', joinedColumns: ['currency', 'price'], sortable: true }
    ];

    // Product grid features
    const productFeatures = {
      initialItemsPerPage: 5,
      csvExport: true,
      excelExport: true,
      theme: 'dark',
      themeColor: '#556B2F', //#556B2F
      gridModal: true,
      modalConfig: {
        editable: true,
        deletable: true,
        nonEditableFields: ['id', 'createdAt', 'updatedAt']
      },
      dataApiEndPoint: 'http://localhost:3003/product/products',
      gridContainerId: 'productsGrid',
    };

    // Product form schema
    const productSchema = [
      ['checkbox', 'categories', 'Category', { required: true }, {}, []], // options added later
      ['text', 'title', 'Title', { required: true }],
      ['text', 'slug', 'Slug', { required: true }],
      ['text', 'sku', 'SKU'],
      ['textarea', 'description', 'Description'],
      ['textarea', 'shortDescription', 'Short Description'],
      ['singleSelect', 'status', 'Status', { required: true }, {}, [
        { value: 'draft', label: 'Draft', selected: true },
        { value: 'active', label: 'Active' },
        { value: 'archived', label: 'Archived' }
      ]],
      ['singleSelect', 'currency', 'Currency', { required: true }, {}, [
        { value: 'ZAR', label: 'ZAR', selected: true },
        { value: 'USD', label: 'USD' },
        { value: 'EUR', label: 'EUR' }
      ]],
      ['number', 'price', 'Price', { required: true }],
      ['number', 'sale_price', 'Sale Price'],
      ['text', 'image', 'Image URL'],
      ['textarea', 'attributes', 'Attributes (JSON)'],
      ['textarea', 'metadata', 'Metadata (JSON)'],
      ['submit', 'submit', 'Submit']
    ];

    const productFormSettings = {
      themeColor: '#556B2F',
      placeholders: false,
      formContainerId: 'addProductContainer',
      submitOnPage: true
    };

    const productFormParams = {
      action: '#',
      method: 'POST',
      id: 'addProduct',
    };

    let productsData = [];
    let categoriesData = [];

    (async () => {
      const api = new smQL('http://localhost:3003');

      // Fetch products
      const products = await api.get('/product/products');
      console.log('READ products:', products);
      productsData = products;

      // Fetch categories
      const categories = await api.get('/productcategory/productcategories');
      console.log('READ categories:', categories);
      categoriesData = categories;

      // Update product form checkbox options for categories
      const categoryOptions = categoriesData.map(cat => ({
        value: cat.id,
        label: toTitleCase(cat.name)
      }));
      productSchema[0][5] = categoryOptions; // Set options for categories checkbox

      // Initialize AnyGrid instances
      new AnyGrid(categoriesData, categoryColumns, categoryFeatures);
      new AnyGrid(productsData, productColumns, productFeatures);

      // Initialize Formique product form
      const productForm = new Formique(productSchema, productFormSettings, productFormParams);

      // Setup product form submission handler
      const productFormHandler = new Form(productFormParams.id);
      productFormHandler.form.addEventListener('form:captured', async ({ detail }) => {
        console.log("Product form data:", JSON.stringify(detail, null, 2));
        await api.post('/product/products', detail, { formId: productFormParams.id });
      });
    })();
  </script>
</head>
<body>
  <div id="anygrid"></div>
  <br />
  <div id="productsGrid"></div>
  <br />
  <div id="addProductContainer" class="width-half"></div>
</body>
</html>
